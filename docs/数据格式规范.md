# ç¤¾åŒºç›‘æ§ç³»ç»Ÿ - æ•°æ®æ ¼å¼è§„èŒƒ

## 1. Discord æ¶ˆæ¯æå–æ ¼å¼

### 1.1 è¾“å…¥ç¤ºä¾‹ï¼ˆæˆªå›¾å†…å®¹ï¼‰
```
chip 21:18
ã“ã‚“ã°ã‚“ã¯
ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™

ãƒ¤ãƒ‹ã¡ã‚ƒã ğŸ®ã‚«ã‚¤ã‚¸ 21:55
ã‚„ã°ã„...ã‚‚ã†ã‚„ã‚‰ãªã™ãã¦ãŠã˜ã„ã¡ã‚ƒã‚“åŒ–ã—ã¦ã‚‹...ã‚„ã‚ã†ã‹ãªä¹…ã€…ã«

@ego111. å†é€æ˜¨æ—¥å§‹ã‚ã¾ã—ãŸã€‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚discordåˆå¿ƒè€…ãªã®ã§ã‚ˆãåˆ†ã‹ã£ã¦ã„ã¾ã›ã‚“(è‡ª...)
æƒ…å ±å±‹Raphael 22:18
åˆ†ã‹ã‚‰ãªã„ã“ã¨ãªã©ã¯æ”»ç•¥ã¨ã‹ã«æ›¸ã„ã¦ã‚ã£ãŸã‚Šã—ãŸã‚Šã™ã‚‹ã—è³ªå•ã«ã‚‚è‰²ã€…æ›¸ã„ã¦ã‚ã‚‹ã‹ã‚‰æ°—ã«ãªã‚‹ã“ã¨ã¯è‰²ã€…è¦‹ã¦è¦‹ã‚ˆã†

ego111. 22:50
ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™
```

### 1.2 æå–è§„åˆ™
1. **æ˜µç§°è¯†åˆ«**ï¼š
   - æ”¯æŒä¸­æ–‡ã€æ—¥æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
   - æ”¯æŒ emojiï¼ˆå¦‚ï¼šğŸ®ã‚«ã‚¤ã‚¸ï¼‰
   - æ”¯æŒ @ æåŠï¼ˆæå–æ—¶å»æ‰ @ï¼‰

2. **æ—¶é—´æ ¼å¼**ï¼š
   - æ ‡å‡†æ ¼å¼ï¼šHH:MMï¼ˆ24å°æ—¶åˆ¶ï¼‰
   - ç¤ºä¾‹ï¼š21:18, 22:50

3. **æ¶ˆæ¯å†…å®¹**ï¼š
   - ä¿ç•™æ‰€æœ‰æ¢è¡Œç¬¦
   - ä¿ç•™ emoji å’Œç‰¹æ®Šå­—ç¬¦
   - å»é™¤ç³»ç»Ÿé€šçŸ¥å’Œè¡¨æƒ…å›åº”
   - ä¿ç•™ @æåŠ åœ¨æ¶ˆæ¯å†…å®¹ä¸­

### 1.3 JSON è¾“å‡ºæ ¼å¼
```json
{
  "messages": [
    {
      "nickname": "chip",
      "messageTime": "21:18",
      "content": "ã“ã‚“ã°ã‚“ã¯\nã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™"
    },
    {
      "nickname": "ãƒ¤ãƒ‹ã¡ã‚ƒã",
      "messageTime": "21:55",
      "content": "ã‚„ã°ã„...ã‚‚ã†ã‚„ã‚‰ãªã™ãã¦ãŠã˜ã„ã¡ã‚ƒã‚“åŒ–ã—ã¦ã‚‹...ã‚„ã‚ã†ã‹ãªä¹…ã€…ã«"
    },
    {
      "nickname": "æƒ…å ±å±‹Raphael",
      "messageTime": "22:18",
      "content": "åˆ†ã‹ã‚‰ãªã„ã“ã¨ãªã©ã¯æ”»ç•¥ã¨ã‹ã«æ›¸ã„ã¦ã‚ã£ãŸã‚Šã—ãŸã‚Šã™ã‚‹ã—è³ªå•ã«ã‚‚è‰²ã€…æ›¸ã„ã¦ã‚ã‚‹ã‹ã‚‰æ°—ã«ãªã‚‹ã“ã¨ã¯è‰²ã€…è¦‹ã¦è¦‹ã‚ˆã†"
    },
    {
      "nickname": "ego111.",
      "messageTime": "22:50",
      "content": "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™"
    }
  ]
}
```

## 2. Excel è¡¨æ ¼å­˜å‚¨è§„èŒƒ

### 2.1 æ–‡ä»¶å‘½å
```
è·¯å¾„ï¼š./data/excel/
æ ¼å¼ï¼šYYYY-MM-DD_HH.xlsx
ç¤ºä¾‹ï¼š
  - 2026-02-05_21.xlsx  (21:00-21:59)
  - 2026-02-05_22.xlsx  (22:00-22:59)
```

### 2.2 è¡¨æ ¼åˆ—å®šä¹‰

| åˆ—å | æ•°æ®ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|----------|------|------|
| A: åºå· | æ•´æ•° | è‡ªå¢ID | 1, 2, 3... |
| B: ç©å®¶æ˜µç§° | æ–‡æœ¬ | Discordæ˜µç§° | chip, ãƒ¤ãƒ‹ã¡ã‚ƒã |
| C: å‘è¨€æ—¶é—´ | æ—¶é—´ | HH:MM æ ¼å¼ | 21:18, 22:50 |
| D: å‘è¨€å†…å®¹ | æ–‡æœ¬ï¼ˆè‡ªåŠ¨æ¢è¡Œï¼‰ | å®Œæ•´æ¶ˆæ¯ | ã“ã‚“ã°ã‚“ã¯\nã‚ˆã‚ã—ã |
| E: æƒ…æ„Ÿå€¾å‘ | æ–‡æœ¬ | æ­£é¢/ä¸­æ€§/è´Ÿé¢ | è´Ÿé¢ |
| F: æƒ…æ„Ÿåˆ†æ•° | æ•°å€¼ | -1.0 ~ 1.0 | -0.75 |
| G: å†…å®¹ç±»å‹ | æ–‡æœ¬ | BUG/æŠ±æ€¨/æ±‚åŠ©/é—²èŠ | æŠ±æ€¨ |
| H: å…³é”®è¯ | æ–‡æœ¬ | é€—å·åˆ†éš” | ã‚„ã°ã„, ä¹…ã€… |
| I: æ˜¯å¦å‘Šè­¦ | æ–‡æœ¬ | æ˜¯/å¦ | æ˜¯ |
| J: æˆªå›¾è·¯å¾„ | æ–‡æœ¬ | ç›¸å¯¹è·¯å¾„ | ./screenshots/20260205_215530.png |
| K: æˆªå±æ—¶é—´ | æ—¥æœŸæ—¶é—´ | å®Œæ•´æ—¶é—´æˆ³ | 2026-02-05 21:55:30 |

### 2.3 Excel æ ·å¼è§„èŒƒ

```typescript
// æ ‡é¢˜è¡Œæ ·å¼
headerStyle = {
  font: { bold: true, size: 12 },
  fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } },
  font: { color: { argb: 'FFFFFFFF' } },
  alignment: { horizontal: 'center', vertical: 'middle' }
}

// æ•°æ®è¡Œæ ·å¼
dataStyle = {
  alignment: { wrapText: true, vertical: 'top' }
}

// å‘Šè­¦è¡Œé«˜äº®
alertRowStyle = {
  fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFEB9C' } }
}

// åˆ—å®½è®¾ç½®
columnWidths = {
  A: 6,   // åºå·
  B: 15,  // ç©å®¶æ˜µç§°
  C: 10,  // å‘è¨€æ—¶é—´
  D: 50,  // å‘è¨€å†…å®¹ï¼ˆæœ€å®½ï¼‰
  E: 10,  // æƒ…æ„Ÿå€¾å‘
  F: 10,  // æƒ…æ„Ÿåˆ†æ•°
  G: 12,  // å†…å®¹ç±»å‹
  H: 20,  // å…³é”®è¯
  I: 10,  // æ˜¯å¦å‘Šè­¦
  J: 30,  // æˆªå›¾è·¯å¾„
  K: 20   // æˆªå±æ—¶é—´
}
```

## 3. å‘Šè­¦é‚®ä»¶å†…å®¹è§„èŒƒ

### 3.1 é‚®ä»¶ä¸»é¢˜æ ¼å¼
```
ã€æ¸¸æˆç¤¾åŒºå‘Šè­¦ã€‘{å‘Šè­¦ç±»å‹} - {æ—¥æœŸæ—¶é—´}

ç¤ºä¾‹ï¼š
ã€æ¸¸æˆç¤¾åŒºå‘Šè­¦ã€‘ç©å®¶æŠ±æ€¨ - 2026-02-05 21:55
ã€æ¸¸æˆç¤¾åŒºå‘Šè­¦ã€‘BUGåé¦ˆ - 2026-02-05 14:30
```

### 3.2 é‚®ä»¶æ­£æ–‡ç»“æ„

```markdown
# ã€æ¸¸æˆç¤¾åŒºå‘Šè­¦ã€‘æ£€æµ‹åˆ°ç©å®¶è´Ÿé¢åé¦ˆ

## ğŸ“Œ å‘Šè­¦ä¿¡æ¯
- **å‘Šè­¦æ—¶é—´**ï¼š2026-02-05 21:55:30
- **ç›‘æ§å¹³å°**ï¼šDiscord - ã€å…¬å¼ã€‘æ–ã¨å‰£ã®ä¼èªª
- **å‘Šè­¦ç±»å‹**ï¼šç©å®¶æŠ±æ€¨
- **æƒ…æ„Ÿåˆ†æ•°**ï¼š-0.75ï¼ˆè´Ÿé¢ï¼‰
- **å…³é”®è¯**ï¼šã‚„ã°ã„, ä¹…ã€…

---

## ğŸ“ åŸå§‹å¯¹è¯å†…å®¹

**ãƒ¤ãƒ‹ã¡ã‚ƒã** 21:55
> ã‚„ã°ã„...ã‚‚ã†ã‚„ã‚‰ãªã™ãã¦ãŠã˜ã„ã¡ã‚ƒã‚“åŒ–ã—ã¦ã‚‹...ã‚„ã‚ã†ã‹ãªä¹…ã€…ã«

**æƒ…å ±å±‹Raphael** 22:18
> åˆ†ã‹ã‚‰ãªã„ã“ã¨ãªã©ã¯æ”»ç•¥ã¨ã‹ã«æ›¸ã„ã¦ã‚ã£ãŸã‚Šã—ãŸã‚Šã™ã‚‹ã—è³ªå•ã«ã‚‚è‰²ã€…æ›¸ã„ã¦ã‚ã‚‹ã‹ã‚‰æ°—ã«ãªã‚‹ã“ã¨ã¯è‰²ã€…è¦‹ã¦è¦‹ã‚ˆã†

**ego111.** 22:50
> ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™

---

## ğŸ¤– AI è®¨è®ºæ‘˜è¦

ç©å®¶"ãƒ¤ãƒ‹ã¡ã‚ƒã"è¡¨ç¤ºå¾ˆä¹…æ²¡ç©æ¸¸æˆï¼Œæ„Ÿè§‰è‡ªå·±"è€åŒ–"äº†ï¼Œè€ƒè™‘é‡æ–°å¼€å§‹ç©ã€‚å…¶ä»–ç©å®¶æä¾›äº†æ”»ç•¥å’Œé—®ç­”åŒºçš„å¸®åŠ©ä¿¡æ¯ã€‚æ•´ä½“æ°›å›´å‹å¥½ï¼Œä½†è¯¥ç©å®¶å¯èƒ½æ˜¯æµå¤±ç©å®¶ã€‚

**åˆ†æå»ºè®®ï¼š**
- âš ï¸ ç©å®¶å¯èƒ½å·²æµå¤±è¾ƒé•¿æ—¶é—´
- ğŸ’¡ å¯è€ƒè™‘å‘é€å›å½’æ´»åŠ¨/ç¦åˆ©å¸å¼•
- ğŸ‘€ å…³æ³¨è¯¥ç©å®¶åç»­æ˜¯å¦çœŸçš„å›å½’

---

## ğŸ“ é™„ä»¶
- åŸå§‹æˆªå›¾ï¼šscreenshot_20260205_215530.pngï¼ˆè§é™„ä»¶ï¼‰
- æ•°æ®è¡¨æ ¼ï¼š2026-02-05_21.xlsx

---

_æ­¤é‚®ä»¶ç”±æ¸¸æˆç¤¾åŒºç›‘æ§ç³»ç»Ÿè‡ªåŠ¨å‘é€_
```

### 3.3 é™„ä»¶è¦æ±‚
1. **åŸå§‹æˆªå›¾**ï¼šPNG æ ¼å¼ï¼ŒåŸå§‹åˆ†è¾¨ç‡
2. **å½“å‰å°æ—¶çš„ Excel è¡¨æ ¼**ï¼ˆå¯é€‰ï¼‰

## 4. æ•°æ®åº“å­˜å‚¨ç»“æ„

### 4.1 messages è¡¨
```sql
CREATE TABLE messages (
  id TEXT PRIMARY KEY,                  -- UUID
  nickname TEXT NOT NULL,               -- ç©å®¶æ˜µç§°
  message_time TEXT NOT NULL,           -- å‘è¨€æ—¶é—´ HH:MM
  content TEXT NOT NULL,                -- å‘è¨€å†…å®¹
  capture_time DATETIME NOT NULL,       -- æˆªå±æ—¶é—´
  platform TEXT DEFAULT 'Discord',      -- å¹³å°
  sentiment TEXT,                       -- æƒ…æ„Ÿå€¾å‘
  sentiment_score REAL,                 -- æƒ…æ„Ÿåˆ†æ•°
  category TEXT,                        -- å†…å®¹ç±»å‹
  keywords TEXT,                        -- å…³é”®è¯ï¼ˆJSONæ•°ç»„ï¼‰
  need_alert BOOLEAN DEFAULT 0,         -- æ˜¯å¦éœ€è¦å‘Šè­¦
  alerted BOOLEAN DEFAULT 0,            -- æ˜¯å¦å·²å‘Šè­¦
  screenshot_path TEXT,                 -- æˆªå›¾è·¯å¾„
  excel_file TEXT,                      -- æ‰€å±Excelæ–‡ä»¶
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_capture_time ON messages(capture_time);
CREATE INDEX idx_need_alert ON messages(need_alert);
CREATE INDEX idx_alerted ON messages(alerted);
```

### 4.2 alerts è¡¨
```sql
CREATE TABLE alerts (
  id TEXT PRIMARY KEY,
  message_ids TEXT NOT NULL,            -- å…³è”çš„æ¶ˆæ¯IDï¼ˆJSONæ•°ç»„ï¼‰
  alert_type TEXT NOT NULL,             -- å‘Šè­¦ç±»å‹
  summary TEXT NOT NULL,                -- AIæ‘˜è¦
  suggestions TEXT,                     -- å»ºè®®ï¼ˆJSONæ•°ç»„ï¼‰
  email_sent BOOLEAN DEFAULT 0,         -- é‚®ä»¶æ˜¯å¦å·²å‘é€
  email_sent_at DATETIME,               -- é‚®ä»¶å‘é€æ—¶é—´
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 5. å®ç°ç¤ºä¾‹ä»£ç 

### 5.1 æ¶ˆæ¯æå–
```typescript
async function extractMessages(screenshotBase64: string): Promise<Message[]> {
  const prompt = `ä½ æ˜¯ä¸“ä¸šçš„ Discord èŠå¤©è®°å½•åˆ†æåŠ©æ‰‹ã€‚è¯·ä»æˆªå›¾ä¸­æå–å¯¹è¯å†…å®¹ï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡º JSON...`;
  
  const result = await callLMStudio(prompt, screenshotBase64);
  const data = JSON.parse(result);
  
  return data.messages.map((msg: any) => ({
    id: generateUUID(),
    nickname: msg.nickname,
    messageTime: msg.messageTime,
    content: msg.content,
    captureTime: new Date(),
    platform: 'Discord'
  }));
}
```

### 5.2 Excel å¯¼å‡º
```typescript
import ExcelJS from 'exceljs';

async function saveToExcel(messages: Message[], hour: number) {
  const date = format(new Date(), 'yyyy-MM-dd');
  const filename = `${date}_${hour.toString().padStart(2, '0')}.xlsx`;
  const filepath = path.join('./data/excel', filename);
  
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('ç›‘æ§æ•°æ®');
  
  // è®¾ç½®åˆ—
  worksheet.columns = [
    { header: 'åºå·', key: 'id', width: 6 },
    { header: 'ç©å®¶æ˜µç§°', key: 'nickname', width: 15 },
    { header: 'å‘è¨€æ—¶é—´', key: 'messageTime', width: 10 },
    { header: 'å‘è¨€å†…å®¹', key: 'content', width: 50 },
    { header: 'æƒ…æ„Ÿå€¾å‘', key: 'sentiment', width: 10 },
    { header: 'æƒ…æ„Ÿåˆ†æ•°', key: 'score', width: 10 },
    { header: 'å†…å®¹ç±»å‹', key: 'category', width: 12 },
    { header: 'å…³é”®è¯', key: 'keywords', width: 20 },
    { header: 'æ˜¯å¦å‘Šè­¦', key: 'needAlert', width: 10 },
    { header: 'æˆªå›¾è·¯å¾„', key: 'screenshot', width: 30 },
    { header: 'æˆªå±æ—¶é—´', key: 'captureTime', width: 20 }
  ];
  
  // æ ‡é¢˜è¡Œæ ·å¼
  worksheet.getRow(1).font = { bold: true };
  worksheet.getRow(1).fill = {
    type: 'pattern',
    pattern: 'solid',
    fgColor: { argb: 'FF4472C4' }
  };
  
  // æ·»åŠ æ•°æ®
  messages.forEach((msg, index) => {
    const row = worksheet.addRow({
      id: index + 1,
      nickname: msg.nickname,
      messageTime: msg.messageTime,
      content: msg.content,
      sentiment: msg.analysis?.sentiment,
      score: msg.analysis?.score,
      category: msg.analysis?.category,
      keywords: msg.analysis?.keywords?.join(', '),
      needAlert: msg.analysis?.needAlert ? 'æ˜¯' : 'å¦',
      screenshot: msg.screenshotPath,
      captureTime: format(msg.captureTime, 'yyyy-MM-dd HH:mm:ss')
    });
    
    // å‘Šè­¦è¡Œé«˜äº®
    if (msg.analysis?.needAlert) {
      row.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFEB9C' }
      };
    }
    
    // è‡ªåŠ¨æ¢è¡Œ
    row.alignment = { wrapText: true, vertical: 'top' };
  });
  
  await workbook.xlsx.writeFile(filepath);
  return filename;
}
```

### 5.3 é‚®ä»¶å‘é€
```typescript
import nodemailer from 'nodemailer';

async function sendAlertEmail(alert: Alert, messages: Message[]) {
  const transporter = nodemailer.createTransporter({
    host: config.email.smtp.host,
    port: config.email.smtp.port,
    secure: false,
    auth: {
      user: config.email.smtp.user,
      pass: config.email.smtp.pass
    }
  });
  
  const originalContent = messages.map(msg => 
    `**${msg.nickname}** ${msg.messageTime}\n> ${msg.content}`
  ).join('\n\n');
  
  const html = `
    <h1>ã€æ¸¸æˆç¤¾åŒºå‘Šè­¦ã€‘æ£€æµ‹åˆ°ç©å®¶è´Ÿé¢åé¦ˆ</h1>
    
    <h2>ğŸ“Œ å‘Šè­¦ä¿¡æ¯</h2>
    <ul>
      <li><strong>å‘Šè­¦æ—¶é—´ï¼š</strong>${format(alert.createdAt, 'yyyy-MM-dd HH:mm:ss')}</li>
      <li><strong>å‘Šè­¦ç±»å‹ï¼š</strong>${alert.alertType}</li>
      <li><strong>ç›‘æ§å¹³å°ï¼š</strong>Discord</li>
    </ul>
    
    <h2>ğŸ“ åŸå§‹å¯¹è¯å†…å®¹</h2>
    <pre>${originalContent}</pre>
    
    <h2>ğŸ¤– AI è®¨è®ºæ‘˜è¦</h2>
    <p>${alert.summary}</p>
    
    <h3>åˆ†æå»ºè®®ï¼š</h3>
    <ul>
      ${alert.suggestions.map(s => `<li>${s}</li>`).join('')}
    </ul>
  `;
  
  await transporter.sendMail({
    from: config.email.from,
    to: config.email.to,
    subject: `ã€æ¸¸æˆç¤¾åŒºå‘Šè­¦ã€‘${alert.alertType} - ${format(new Date(), 'yyyy-MM-dd HH:mm')}`,
    html: html,
    attachments: [
      {
        filename: 'screenshot.png',
        path: messages[0].screenshotPath
      }
    ]
  });
}
```

## 6. å…³é”®é…ç½®é¡¹

```json
{
  "monitor": {
    "interval": 60,
    "saveDuration": 30
  },
  "excel": {
    "outputPath": "./data/excel",
    "autoArchive": true,
    "archiveAfterDays": 30
  },
  "alert": {
    "enabled": true,
    "threshold": -0.5,
    "batchMode": false,
    "deduplicateWindow": 1800
  },
  "email": {
    "includeScreenshot": true,
    "includeExcelAttachment": false
  }
}
```
