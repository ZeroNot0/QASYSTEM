# Jp-Linker 技术方案 v1.0

> 基于 PRD 与 Gemini 2.5 的技术选型与架构设计  
> 文档版本：v1.0 | 更新日期：2025-02-04

---

## 1. 技术选型总览

| 维度 | 选型 | 说明 |
|------|------|------|
| 桌面端框架 | **Tauri 2.x** | 轻量、安全、Windows 原生体验；截屏/置顶窗口用系统 API 更稳定 |
| 前端 UI | **React 18 + TypeScript** | 组件化、状态管理清晰，便于实时翻译与流式 UI |
| 样式 | **Tailwind CSS** | 快速实现窄长悬浮窗、左右分栏、响应式 |
| AI 能力 | **Google Gemini 2.5 Pro** | 多模态（图+文）、流式输出、强翻译与敬语控制 |
| 知识库解析 | **本地 Node/Rust 侧** | xlsx → 文本用 `xlsx`（JS）或 `calamine`（Rust）；docx 用 `mammoth`（JS）或 `docx` crate |
| API Key 存储 | **项目内 `APIKEYS/` 目录** | 从 `APIKEYS/APIKEYS.txt` 读取，不写死在代码中；可选后续加本地加密 |

**备选**：若优先验证产品、对安装包体积不敏感，可改用 **Electron + React**，截屏可用 `electron-screenshot-service` 或系统调用，开发速度更快。

### 1.1 轻量化策略（推荐）

在满足 PRD 核心闭环的前提下，尽量少依赖、少层级、先跑通再优化：

| 维度 | 轻量做法 | 说明 |
|------|----------|------|
| 桌面壳 | **Electron** | 生态成熟，截屏/置顶/全局快捷键方案多，上手快；打包体积可接受（~150MB）。 |
| 前端 | **React + Vite** | 不引入 Redux，用 `useState` + `useContext` 即可；Tailwind 按需即可。 |
| 状态 | 单 store 或 Context | 避免 Zustand/Redux，仅：截图结果、知识库文本、当前输入、语气、加载态。 |
| 知识库格式 | **先只做 xlsx** | v1.0 仅支持 Excel，解析用 `xlsx` 一个库；docx 放到 v1.1。 |
| 流式 | 先非流式再流式 | 首版可「整段返回」日文，确认流程后再加 SSE 逐字；能省 1–2 天。 |
| 引用来源 | v1.1 | 首版可不展示「参考了哪一行」，只做翻译 + 知识库注入。 |
| 意图分类 | 可选 | 首版左区只展示「日文原文 + 中文释义」，意图标签可后补。 |

按上述收缩后，**核心闭环**仍为：截屏 → 识别+翻译 → 知识库注入 → 中文输入 → 日文输出 + 语气切换。

---

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Jp-Linker 桌面应用 (Tauri)                         │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │
│  │  截屏模块    │  │  知识库模块   │  │  翻译/流式   │  │  语气控制 UI     │ │
│  │  (Alt+Q)    │  │  加载/刷新    │  │  (SSE)      │  │  丁寧/謙譲/親密  │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘ │
│         │                │                │                   │         │
│         └────────────────┴────────────────┴───────────────────┘         │
│                                    │                                     │
│                          ┌─────────▼─────────┐                           │
│                          │  统一 AI 网关层    │  (Prompt 组装 / 重试)     │
│                          └─────────┬─────────┘                           │
└────────────────────────────────────┼─────────────────────────────────────┘
                                     │ HTTPS
                     ┌────────────────▼────────────────┐
                     │  Google AI (Gemini 2.5 Pro API)  │
                     │  - 多模态：图片 + 文本            │
                     │  - 流式：generateContentStream   │
                     └─────────────────────────────────┘
```

- **截屏**：Tauri 侧调用 Windows API 或使用全局快捷键 + 选区截屏，得到图片 Buffer/Base64。
- **知识库**：本地读取指定目录下 `.xlsx` / `.docx`，解析为纯文本，在每次请求中作为 `local_kb_text` 注入 Prompt。
- **翻译**：中文输入 → 组装 Prompt（含知识库 + 玩家问题 + 语气）→ 调用 Gemini 2.5 流式接口 → SSE 推送到前端，日文逐字更新。
- **API Key**：应用启动时从 `APIKEYS/APIKEYS.txt` 读取（或从 Tauri 配置的 path 读取），不落库、不提交版本库。

---

## 3. 核心模块设计

### 3.1 截屏与多模态识别

- **快捷键**：全局监听 `Alt+Q`（可配置），触发截屏选区。
- **实现**：
  - **Tauri**：Rust 侧用 `screenshots` 或调用 Windows 剪贴板/截图 API，或前端用 `html2canvas` 等做窗口内截屏；若需“全屏选区”，可考虑系统级库（如 Windows Graphics Capture）或调用系统自带截图工具并监听剪贴板。
  - **Electron**：`desktopCapturer` + 选区窗口，或集成 `electron-screenshot-service`。
- **上传**：截图得到 PNG/JPEG Buffer → Base64 或 `Part` 形式随请求体发给 Gemini 2.5。
- **接口**：Gemini 2.5 Pro 多模态 `generateContent`（一次性）或 `generateContentStream`（若该步也需流式）。
- **返回**：结构化解析为：
  - `ocr_text`：识别出的日文原文
  - `chinese_summary`：中文释义
  - `intent`：意图分类（如 account_lost / payment_issue / game_suggestion）

**性能**：PRD 要求截图到结果 < 1.5s，建议仅传压缩后图片（如 1024px 宽）、单次请求完成 OCR+翻译+分类，避免多轮调用。

### 3.2 本地知识库

- **配置**：设置页持久化「知识库文件夹路径」（存于本地配置文件或 Tauri app data）。
- **格式**：支持 `.xlsx`、`.docx`；可扩展 `.txt` / `.md`。
- **解析**：
  - **xlsx**：Node 侧 `xlsx` 库读 sheet，按行/列拼成 `"行号: 单元格内容"` 的文本块。
  - **docx**：`mammoth` 转 HTML 再抽纯文本，或 `docx` 库直接读段落。
- **注入**：每次调用 Gemini 时，将当前知识库全文放入 Prompt 的 `{{local_kb_text}}`，并限制长度（如前 8k tokens），超长则截断并提示。
- **热更新**：提供「刷新」按钮，重新扫描目录、重新解析并更新内存中的 `local_kb_text`；界面显示「已加载 / 条数」及状态灯（绿/红）。

### 3.3 双向实时翻译（中文 → 日文）

- **输入**：客服在「中文输入框」输入，防抖约 300–500ms 后发起请求（避免每字一请求）。
- **请求**：POST Gemini 2.5 Pro `generateContentStream`，Body 含：
  - 系统 Role + 约束（敬语、术语一致）
  - `ocr_text`、`local_kb_text`、`tone_setting`、客服当前中文 `user_input`
- **流式**：使用 SSE 或 Google SDK 的 stream 回调，每收到一段 token 就追加到日文预览区，实现「逐字跳动」。
- **实时修正**：中文修改 → 防抖结束 → 重新请求；可对未完成请求做 abort，避免旧结果覆盖新结果。
- **延迟**：首字 < 500ms 需依赖模型与网络；可考虑 Gemini 2.5 Flash 做“首包加速”或前端骨架占位。

### 3.4 语气/敬语控制器

- **档位**：丁寧 / 謙譲 / 親密，对应 `tone_setting` 字符串写入 Prompt。
- **实现**：前端下拉或 Tab 切换，状态提升到全局（如 React context 或 Tauri state），翻译请求时一并传入。

### 3.5 API Key 与安全

- **读取**：从项目内 `APIKEYS/APIKEYS.txt` 读取（第一行或按行解析，约定格式如 `GEMINI_API_KEY=xxx` 或纯 key）。
- **存储**：不提交 `APIKEYS/` 到 Git（`.gitignore` 已包含）；生产安装包中可由用户首次设置路径或粘贴 key，再写入应用数据目录。
- **加密（可选）**：v1.1 可对写入应用目录的 key 做系统级加密（如 Windows DPAPI），当前版本可先明文存于用户可控目录。
- **网络**：仅与 Google API 通信；知识库不离开本机。

---

## 4. Gemini 2.5 使用约定

- **模型**：`gemini-2.5-pro`（多模态 + 高质量翻译）；若延迟敏感可部分场景用 `gemini-2.5-flash`。
- **端点**：`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent` 或 `:streamGenerateContent`。
- **认证**：Query 参数 `?key=YOUR_API_KEY` 或 Header `x-goog-api-key`。
- **图片**：inline_data 的 `mime_type` + `data`（Base64）。
- **流式**：使用 `streamGenerateContent`，按 chunk 解析 `text` 并推前端。

（具体字段以 Google 官方最新文档为准：https://ai.google.dev/api ）

---

## 5. 目录与工程结构建议

```
QASYSTEM/
├── APIKEYS/
│   └── APIKEYS.txt          # 已存在，不提交
├── PRD.md
├── docs/
│   └── 技术方案.md           # 本文档
├── src-tauri/               # Tauri 后端（若选 Tauri）
│   ├── src/
│   │   ├── main.rs
│   │   ├── screenshot.rs
│   │   ├── knowledge.rs
│   │   ├── gemini.rs        # API 调用与流式
│   │   └── lib.rs
│   └── Cargo.toml
├── src/                     # 前端 (React)
│   ├── components/
│   │   ├── CaptureBar.tsx
│   │   ├── PlayerPanel.tsx   # 左区：原文+中文
│   │   ├── AgentPanel.tsx    # 右区：输入+日文预览
│   │   ├── ToneSelector.tsx
│   │   └── KnowledgeStatus.tsx
│   ├── hooks/
│   │   ├── useGeminiStream.ts
│   │   └── useKnowledge.ts
│   ├── stores/              # 或 context
│   ├── App.tsx
│   └── main.tsx
├── package.json
├── .gitignore                # 含 APIKEYS/
└── tauri.conf.json
```

---

## 6. 关键 Prompt 逻辑（与 PRD 一致）

- **Role**：资深日本游戏客服专家，精通中日互译。
- **Context**：  
  - 玩家问题截图内容：`{{ocr_text}}`  
  - 内部知识库参考：`{{local_kb_text}}`
- **Task**：将客服输入的中文翻译为地道的日文。
- **Constraint**：必须使用 `{{tone_setting}}` 语气；严格使用知识库中的名词术语；若知识库未提及则保持翻译地道性。
- **输出**：仅日文正文；若需“引用来源”，可在同一轮或后续轮让模型返回引用行号，再映射到界面「引用来源」区域。

---

## 7. 非功能性需求落地

- **延迟**：截图→结果 < 1.5s：单次多模态请求 + 图片压缩 + 可选 CDN/区域端点。  
  中文→日文首字 < 500ms：流式 + 防抖不宜过大（如 300ms）+ 考虑 Flash 做首包。
- **离线**：请求前检测网络（navigator.onLine 或 ping）；失败时界面明确提示「网络不可用，请检查连接」。
- **安全性**：API Key 仅从本地文件或用户配置读取；不写死、不提交；知识库仅发往 Google API。

---

## 8. 风险与依赖

- **Gemini 2.5 可用区与配额**：依赖 Google 服务可用性，需处理 429/5xx 与重试策略。
- **截屏权限**：Windows 上全局快捷键与截屏可能需管理员或辅助功能权限，安装时需说明。
- **知识库规模**：大体积 Excel/Word 需做长度截断与分块策略，避免超 token 限制。

---

## 9. 落地周期估算

以 **1 人、按轻量化方案（Electron + React + 先 xlsx + 首版可非流式）** 为基准：

| 阶段 | 内容 | 预估人天 |
|------|------|----------|
| 搭架子 | 初始化 Electron + Vite + React + Tailwind，窗口置顶/窄长布局，读 APIKEYS | **1** |
| 截屏 | 全局快捷键 Alt+Q、选区截屏、转 Base64、调 Gemini 2.5 多模态 | **2** |
| 左区展示 | 日文原文 + 中文释义（意图分类可选） | **0.5** |
| 知识库 | 选择文件夹、扫 xlsx、解析为文本、刷新按钮与状态灯、注入 Prompt | **1.5** |
| 翻译链路 | 中文输入 → 防抖 → 调 Gemini（先非流式）、右区日文展示、语气切换 | **1.5** |
| 流式（可选） | 改为 streamGenerateContent，SSE/逐字更新 | **1** |
| 联调与收尾 | 错误提示、断网提示、一键复制、简单设置页 | **1** |

- **不含流式**：约 **7 人天**（约 1.5 周）。
- **含流式**：约 **8 人天**（约 2 周）。

若选 Tauri、或首版就做 docx + 引用来源 + 意图分类，整体再加约 2–4 人天。

---

## 10. 下一步

1. 按轻量化方案初始化 **Electron + Vite + React**，确认 `.gitignore` 含 `APIKEYS/`。
2. 实现从 `APIKEYS/APIKEYS.txt` 读取 Key，封装 Gemini 2.5 的 `generateContent`（及可选 `streamGenerateContent`）。
3. 实现截屏链路（快捷键 → 选区 → 多模态解析）与左区展示。
4. 实现知识库（仅 xlsx）扫描、解析、刷新与状态灯。
5. 实现中文输入 → 日文输出与语气切换；再视需要加流式与引用来源。

以上为 Jp-Linker 技术方案 v1.0，后续可根据实现情况在本文档中增补接口约定与迭代说明。
