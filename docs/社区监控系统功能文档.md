# 社区监控系统功能文档 (Community Monitor System)

## 概述
游戏社区自动监控系统，用于实时监控玩家在 Discord 等社交平台的讨论内容，及时发现并响应玩家的问题反馈、BUG 报告和负面情绪。

---

## 功能模块

### 1. 区域选择与固定 (Area Selection)

#### 功能描述
- 用户可以框选屏幕上的**固定监控区域**
- 保存区域坐标，后续自动截取该区域
- 支持调整和重新设置监控区域

#### 技术实现
- 提供可视化框选工具
- 保存区域坐标到本地配置文件
- 支持多个监控区域（Discord、QQ、微信等）

#### UI 交互
```
[设置监控区域] 按钮
  → 显示透明覆盖层
  → 用户拖拽框选区域
  → 确认并保存坐标
```

---

### 2. 定时自动截屏 (Scheduled Screenshot)

#### 功能描述
- 按设定时间间隔自动截取监控区域
- 默认间隔：60 秒（可配置：30秒-5分钟）
- 后台运行，不影响用户操作

#### 技术实现
- 使用 `setInterval` 定时器
- Electron 主进程捕获指定区域截图
- 截图缓存策略：保留最近 100 张，自动清理旧截图

#### 配置项
```typescript
interface ScheduleConfig {
  enabled: boolean          // 是否启用自动截屏
  interval: number          // 间隔时间（秒）
  areaId: string           // 监控区域ID
  saveScreenshots: boolean // 是否保存原始截图
}
```

---

### 3. 文字识别与格式化 (OCR & Formatting)

#### 功能描述
- 使用 VLM 模型识别截图中的对话内容
- 提取结构化信息：
  - 时间戳
  - 用户名/昵称
  - 消息内容
  - 上下文关系

#### 识别流程
```
截图 → VLM 识别 → 文本解析 → 结构化数据
```

#### 数据格式

**从截图中提取的结构：**
```
用户名        时间      发言内容
chip         21:18     こんばんは
                       よろしくお願いします
ヤニちゃそ    21:55     やばい...もうやらなすぎておじいちゃん化してる...
情報屋Raphael 22:18    分からないことなどは攻略とかに書いてあったり...
```

**数据结构：**
```typescript
interface Message {
  id: string              // 消息唯一ID
  nickname: string        // 玩家昵称（如：chip, ヤニちゃそ）
  messageTime: string     // 发言时间（如：21:18, 22:50）
  content: string         // 发言内容（完整文本）
  captureTime: Date       // 截屏时间
  platform: string        // 平台（Discord/QQ等）
  screenshotPath?: string // 截图路径
}
```

#### Prompt 设计

**识别提取 Prompt：**
```
你是专业的 Discord 聊天记录分析助手。请从截图中提取对话内容，严格按照以下格式输出 JSON：

{
  "messages": [
    {
      "nickname": "玩家昵称",
      "messageTime": "HH:MM 格式的时间",
      "content": "完整的消息内容"
    }
  ]
}

示例输入（截图内容）：
chip 21:18
こんばんは
よろしくお願いします

ヤニちゃそ 21:55
やばい...もうやらなすぎておじいちゃん化してる...

示例输出：
{
  "messages": [
    {
      "nickname": "chip",
      "messageTime": "21:18",
      "content": "こんばんは\nよろしくお願いします"
    },
    {
      "nickname": "ヤニちゃそ",
      "messageTime": "21:55",
      "content": "やばい...もうやらなすぎておじいちゃん化してる..."
    }
  ]
}

要求：
1. 准确提取玩家昵称（包含特殊字符、emoji）
2. 提取 HH:MM 格式的时间
3. 保留消息的完整内容和换行
4. 保持原始语言不翻译
5. 忽略系统消息、通知和表情回应
6. 每条消息单独一个对象
```

---

### 4. 智能内容分析 (Content Analysis)

#### 功能描述
- 分析消息的**情感倾向**（正面/中性/负面）
- 识别**关键词和主题**
- 分类消息类型

#### 分析维度

##### 4.1 情感分析
- **负面** (-1 ~ -0.3): BUG、崩溃、卡顿、垃圾、失望
- **中性** (-0.3 ~ 0.3): 普通交流、询问、讨论
- **正面** (0.3 ~ 1): 好玩、推荐、感谢、喜欢

##### 4.2 内容分类
- 🐛 **BUG 报告**: 崩溃、闪退、卡顿、无法进入
- 😤 **负面反馈**: 抱怨、失望、差评、退坑
- ❓ **问题求助**: 如何、怎么、为什么
- 💡 **建议反馈**: 希望、建议、改进
- 💬 **正常交流**: 日常聊天、闲聊

##### 4.3 关键词库
```typescript
const KEYWORDS = {
  bug: ['BUG', 'bug', '崩溃', '闪退', '卡顿', '错误', '异常'],
  complaint: ['垃圾', '烂', '差', '失望', '退坑', '不玩了'],
  help: ['怎么', '如何', '为什么', '求助', '问下'],
  positive: ['好玩', '推荐', '厉害', '喜欢', '感谢']
}
```

#### 分析 Prompt
```
分析以下游戏社区对话，判断情感倾向和内容类型：

对话内容：
{messages}

输出 JSON 格式：
{
  "sentiment": "negative" | "neutral" | "positive",
  "score": -1.0 ~ 1.0,
  "category": "bug" | "complaint" | "help" | "suggestion" | "chat",
  "keywords": ["关键词1", "关键词2"],
  "summary": "内容摘要（中文，不超过50字）",
  "needsAlert": true | false
}

判断标准：
- 提到BUG、崩溃、闪退 → category: "bug", needsAlert: true
- 明显抱怨、负面情绪 → s存储（按小时分表）

**文件命名规则：**
```
数据存储路径: ./data/excel/
文件命名格式: YYYY-MM-DD_HH.xlsx

示例：
2026-02-05_00.xlsx  (0:00-0:59 的消息)
2026-02-05_01.xlsx  (1:00-1:59 的消息)
2026-02-05_22.xlsx  (22:00-22:59 的消息)
```

**表格结构：**
| 列名 | 说明 | 示例 |
|------|------|------|
| 序号 | 自增ID | 1, 2, 3... |
| 玩家昵称 | Discord昵称 | chip, ヤニちゃそ |
| 发言时间 | HH:MM 格式 | 21:18, 22:50 |
| 发言内容 | 完整消息文本 | こんばんは\nよろしくお願いします |
| 情感倾向 | 正面/中性/负面 | 负面 |
| 情感分数 | -1.0 ~ 1.0 | -0.75 |
| 内容类型 | BUG/抱怨/求助等 | 抱怨 |
| 关键词 | 提取的关键词 | やばい, 久々 |
| 是否告警 | 是/否 | 是 |
| 截图路径 | 原始截图 | ./screenshots/20260205_215500.png |

**Excel 示例：**
```
2026-02-05_21.xlsx
┌────┬──────────┬────────┬─────────────────────────┬────────┬────────┐
│序号│ 玩家昵称 │发言时间│      发言内容           │情感倾向│是否告警│
├────┼──────────┼────────┼─────────────────────────┼────────┼────────┤
│ 1  │ chip     │ 21:18  │ こんばんは              │  中性  │   否   │
│    │          │        │ よろしくお願いします    │        │        │
├────┼──────────┼────────┼─────────────────────────┼────────┼────────┤
│ 2  │ヤニちゃそ │ 21:55  │ やばい...もうやらなすぎ │  负面  │   是   │
│    │          │        │ ておじいちゃん化してる  │        │        │
└────┴──────────┴────────┴─────────────────────────┴────────┴────────┘
```

**自动管理策略：**
- 每小时自动创建新表格
- 保留最近 30 天的表格
- 超过 30 天的自动归档压缩
---

### 5. 数据存储 (Data Storage)

#### 5.1 本地存储（SQLite）
```sql
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  timestamp DATETIME,
  username TEXT,
  content TEXT,
  platform TEXT,
  sentiment TEXT,
  score REAL,
  category TEXT,
  keywords TEXT,

**告警邮件包含：**
1. **原始对话内容**（完整保留）
2. **AI 生成的讨论摘要**（中文，30-50字）

```html
【游戏社区告警】检测到玩家负面反馈

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 告警信息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
告警时间：2026-02-05 21:55:30
监控平台：Discord - 【公式】杖と剣の伝說
告警类型：玩家抱怨
情感分数：-0.75（负面）
关键词：やばい, 久々

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 原始对话内容
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ヤニちゃそ 21:55
やばい...もうやらなすぎておじいちゃん化してる...やろうかな久々に

情報屋Raphael 22:18
分からないことなどは攻略とかに書いてあったりしたりするし質問にも色々書いてあるから気になることは色々見て見よう

ego111. 22:50
ありがとうございます

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🤖 AI 讨论摘要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
玩家"ヤニちゃそ"表示很久没玩游戏，感觉自己"老化"了，
考虑重新开始玩。其他玩家提供了攻略和问答区的帮助信息。
整体氛围友好，但该玩家可能是流失玩家。

分析建议：
- 玩家可能已流失较长时间
- 可考虑发送回归活动/福利吸引
- 关注该玩家后续是否真的回归

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📎 附件
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
原始截图：见附件 screenshot_20260205_215530.png
数据表格：2026-02-05_21.xlsx

[查看完整数据] [标记已处理] [关闭告警]
```

**摘要生成 Prompt：**
```
请分析以下游戏社区对话，生成中文摘要（30-50字）和处理建议：

原始对话：
{messages}

输出格式：
{
  "summary": "对话摘要（30-50字中文）",
  "suggestions": [
    "建议1",
    "建议2"
  ],
  "playerStatus": "活跃/流失/新手/问题玩家"
}

要求：
1. 摘要准确反映对话主题和情绪
2. 建议具体可执行
3. 判断玩家状态
interface MonitorRecord {
  id: string
  timestamp: Date
  messages: Message[]
  analysis: AnalysisResult
  screenshot: Buffer
  exported: boolean
}
```

---

### 6. 邮件告警系统 (Email Alert)

#### 6.1 触发条件
- `needsAlert === true`（AI 判断需要告警）
- 情感分数 < -0.5（强烈负面）
- 关键词匹配：BUG、崩溃、退坑

#### 6.2 告警策略
- **即时告警**: 检测到立即发送
- **批量告警**: 每小时汇总发送
- **去重机制**: 相似内容 30 分钟内仅告警一次

#### 6.3 邮件内容模板
```html
【游戏社区告警】检测到玩家负面反馈

时间：2026-02-05 00:30:15
平台：Discord
类型：BUG 报告
情感：负面 (-0.8)

用户：PlayerName
内容：
"游戏一直崩溃，根本进不去，太垃圾了！"

关键词：崩溃、垃圾
建议：立即查看并响应

[查看详情] [查看截图]
```

#### 6.4 配置
```typescript
interface EmailConfig {
  enabled: boolean
  smtpHost: string
  smtpPort: number
  username: string
  password: string
  from: string
  to: string[]           // 收件人列表
  alertThreshold: number // 告警阈值（情感分数）
  batchMode: boolean     // 批量模式
  batchInterval: number  // 批量间隔（分钟）
}
```

---

### 7. 监控控制台 (Monitor Dashboard)

#### UI 布局
```
┌─────────────────────────────────────────┐
│ 【监控控制台】                           │
├─────────────────────────────────────────┤
│ 状态: ● 运行中  间隔: 60秒  区域: Discord│
│ [暂停] [设置区域] [导出数据] [设置]      │
├─────────────────────────────────────────┤
│ 实时监控                                 │
│ ┌─────────────────────────────────────┐ │
│ │ 00:30:15  Player1: 游戏好玩         │ │
│ │ 00:31:20  Player2: 怎么进不去了？   │ │
│ │ 00:32:45  Player3: 崩溃了！[告警]   │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 统计信息（今日）                         │
│ 总消息: 1234  BUG: 5  负面: 23  告警: 8  │
└─────────────────────────────────────────┘
```

#### 功能按钮
- **开始/暂停监控**: 控制定时截屏
- **设置区域**: 重新框选监控区域
- **导出数据**: 导出为 Excel
- **清空数据**: 清除历史记录
- **告警设置**: 配置邮件告警

---

## 技术架构

### 技术栈
- **前端**: React + TypeScript + Tailwind CSS
- **后端**: Electron (主进程)
- **AI 模型**: LM Studio (allenai/olmocr-2-7b)
- **数据库**: SQLite (better-sqlite3)
- **Excel**: exceljs
- **邮件**: nodemailer

### 文件结构
```
electron/
  ├── monitor.js          # 监控主逻辑
  ├── area-selector.js    # 区域选择
  └── email.js            # 邮件发送

src/
  ├── components/
  │   ├── MonitorDashboard.tsx  # 监控控制台
  │   ├── AreaSelector.tsx      # 区域选择器
  │   └── AlertSettings.tsx     # 告警设置
  ├── lib/
  │   ├── database.ts     # 数据库操作
  │   ├── analyzer.ts     # 内容分析
  │   └── exporter.ts     # 数据导出
```

---

## 配置文件示例

```json
{
  "monitor": {
    "enabled": false,
    "interval": 60,
    "areas": [
      {
        "id": "discord-main",
        "name": "Discord 主聊天区",
        "x": 100,
        "y": 200,
        "width": 800,
        "height": 600
      }
    ]
  },
  "analysis": {
    "enabled": true,
    "alertThreshold": -0.5,
    "keywords": {
      "bug": ["BUG", "崩溃", "闪退"],
      "complaint": ["垃圾", "差评", "退坑"]
    }
  },
  "email": {
    "enabled": true,
    "smtp": {
      "host": "smtp.gmail.com",
      "port": 587,
      "secure": false,
      "auth": {
        "user": "your-email@gmail.com",
        "pass": "your-app-password"
      }
    },
    "from": "Game Monitor <monitor@yourgame.com>",
    "to": ["admin@yourgame.com"],
    "batchMode": false
  },
  "storage": {
    "dbPath": "./data/monitor.db",
    "screenshotPath": "./data/screenshots",
    "maxScreenshots": 100
  }
}
```

---

## 实施计划

### Phase 1: 基础功能（1-2天）
- [x] 区域选择器 UI
- [x] 定时截屏逻辑
- [x] VLM 文字识别

### Phase 2: 分析与存储（2-3天）
- [ ] 情感分析 Prompt
- [ ] SQLite 数据库
- [ ] Excel 导出功能

### Phase 3: 告警系统（1-2天）
- [ ] 邮件配置与发送
- [ ] 告警规则引擎
- [ ] 去重机制

### Phase 4: 控制台与优化（1-2天）
- [ ] 监控控制台 UI
- [ ] 实时数据展示
- [ ] 性能优化

---

## 使用流程

1. **设置监控区域**
   - 点击"设置区域"按钮
   - 框选 Discord/QQ 聊天窗口
   - 确认保存

2. **配置告警邮箱**
   - 打开设置面板
   - 填写 SMTP 配置
   - 设置告警阈值

3. **启动监控**
   - 点击"开始监控"
   - 系统自动定时截屏
   - 后台分析内容

4. **接收告警**
   - 检测到负面内容
   - 自动发送邮件告警
   - 查看详情处理

---

## 注意事项

1. **隐私保护**: 截图仅本地存储，定期清理
2. **性能优化**: 后台运行不影响游戏性能
3. **误报处理**: 支持手动标记和学习
4. **多平台支持**: 可同时监控多个社区
5. **数据安全**: 敏感信息加密存储

---

## 后续扩展

- [ ] 支持更多 AI 模型（GPT-4V, Claude）
- [ ] Web 端管理后台
- [ ] 实时推送通知（钉钉、企业微信）
- [ ] 情感趋势分析图表
- [ ] 自动回复建议
- [ ] 多语言支持
